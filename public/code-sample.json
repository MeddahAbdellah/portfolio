{
    "text": "console.log(\"Server loading...\");const express=require(\"express\"),bodyParser=require(\"body-parser\"),mysql=require(\"mysql\"),httpRequest=require(\"request\"),moment=require(\"moment-timezone\"),sha256=require(\"sha256\"),app=express(),redis=require(\"redis\");var redisClient=redis.createClient();const mosca=require(\"mosca\");var server=new mosca.Server({port:8080,http:{port:9e3,bundle:!0,static:\"./\"}});server.on(\"clientConnected\",function(e){console.log(\"client connected\",e.id)});var con=mysql.createConnection({host:\"localhost\",user:\"root\",password:\"password\",port:\"3306\",database:\"sten\"});function setup(){console.log(\"Mosca server is up and running\")}con.connect(),server.on(\"published\",function(e,s){console.log(\"topic\",e.topic),console.log(\"Published\",e.payload.toString().split(\",\"));var r=e.payload.toString().split(\",\");if(\"n\"==r[0]){var o=sha256(r[1]+new Date().getTime()).toString().substring(0,10).toUpperCase();con.query(\"INSERT INTO device_sessions SET ?\",{device_id:r[1],session_id:o,session_creation_date:moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")},(e,s)=>{var n=\"\";2==parseInt(r[2])?n=\"low_intensity_program\":1==parseInt(r[2])?n=\"normal_intensity_program\":0==parseInt(r[2])&&(n=\"high_intensity_program\"),con.query(\"SELECT \"+n+\" FROM user_devices WHERE ? \",{device_id:r[1]},(e,s)=>{var n=\"\";2==parseInt(r[2])?n=s[0].low_intensity_program:1==parseInt(r[2])?n=s[0].normal_intensity_program:0==parseInt(r[2])&&(n=s[0].high_intensity_program),con.query(\"SELECT pattern FROM programs WHERE ? \",{name:n},(e,s)=>{console.log(s),s.length>0?(console.log(\"Current Pattern : \"+s[0].pattern),redisClient.set(\"program\"+r[1],s[0].pattern,function(){redisClient.set(\"lastDose\"+r[1],\"0,0\");var e={topic:\"command\"+r[1],payload:\"1,\"+o+\",\"+r[2]+\",\"+r[3],qos:0,retain:!1};server.publish(e,function(){console.log(\"STARTED SESSION\")})})):redisClient.set(\"program\"+r[1],\"\",function(){redisClient.set(\"lastDose\"+r[1],\"0,0\");var e={topic:\"command\"+r[1],payload:\"1,\"+o+\",\"+r[2]+\",\"+r[3],qos:0,retain:!1};server.publish(e,function(){console.log(\"STARTED SESSION\")})})})})})}else if(e.topic.toString().includes(\"data\")&&4==r.length){var n={session_id:r[2],hr_val:r[3],rr_val:r[0],time_interval:r[1],logging_date:moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")};con.query(\"INSERT INTO data SET ?\",n,(e,s)=>{e&&console.error(e)})}else if(8==r.length){var t=\"\";parseInt(r[1])?t+=\"UPDATE parameters SET \":t+=\"INSERT INTO parameters SET session_id=\"+con.escape(r[0])+\", packet_id=\"+con.escape(r[7])+\", insert_date='\"+moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")+\"',\";for(var i=0;i<r.length-3;i++)t+=\" param\"+con.escape(parseInt(r[1])*(r.length-3)+i+1)+\"='\"+r[2+i]+\"'\",i<r.length-4&&(t+=\",\");if(0!=parseInt(r[1])&&(t+=\" WHERE session_id=\"+con.escape(r[0])+\" AND packet_id=\"+con.escape(r[7])),con.query(t,(e,s)=>{e&&console.error(e)}),3==parseInt(r[1])){var a=e.topic.toString().replace(\"data\",\"\");redisClient.get(\"program\"+a,function(e,s){if(console.log(s),null!=s){var o=s.toString().split(\",\");redisClient.get(\"lastDose\"+a,function(e,s){var n=0,t=0,i=-1,d=\"\",p=0,l=0,c=0,m=0;null!=s&&(n=parseInt((s=s.toString().split(\",\"))[0]),t=parseInt(s[1]),Number.isNaN(n)&&(n=0),Number.isNaN(t)&&(t=0));for(var u=0;u<o.length;u+=2)100*parseFloat(r[6])>parseInt(o[u])&&parseInt(o[u+1])!=n&&(o[u]>t||100*parseFloat(r[6])<t)&&(console.log(\"Sending Dose : \"+o[u+1]),u+3>o.length?(p=100,c=100):(p=parseInt(o[u+3]),c=parseInt(o[u+2])),i=(p-(l=o[u+1]))/(c-(m=o[u])),d=o[u+1],redisClient.set(\"lastDose\"+a,d+\",\"+o[u]));if(d.length>0){i>1e3&&(i=1e3);var g={topic:\"program\"+a,payload:d+\",\"+i,qos:0,retain:!1};setTimeout(function(){server.publish(g,function(){console.log(\"GAVE DOSE\")})},50)}})}})}}else if(\"s\"==r[0])con.query(\"SELECT high_intensity, normal_intensity, low_intensity, start_timeout FROM user_devices WHERE ? \",{device_id:r[1]},(e,s)=>{if(e)throw e;if(console.log(s),s.length>0){var o={topic:\"settings\"+r[1],payload:s[0].high_intensity+\",\"+s[0].normal_intensity+\",\"+s[0].low_intensity+\",\"+s[0].start_timeout,qos:0,retain:!1};server.publish(o,function(){console.log(\"GAVE SETTINGS\")})}});else if(\"d\"==r[0]){var d={topic:\"deviceInfo\"+r[3],payload:r[1]+\",\"+r[2],qos:0,retain:!1};server.publish(d,function(){console.log(\"GAVE SETTINGS\")})}}),server.on(\"subscribed\",function(e,s){console.log(\"Device connected : \",e);var r=e.replace(\"settings\",\"\");r=(r=(r=(r=r=e.replace(\"command\",\"\")).replace(\"status\",\"\")).replace(\"data\",\"\")).replace(\"deviceInfo\",\"\");var o=\"w\";s.id.includes(\"esp\")?o=\"m\":s.id.includes(\"APP\")&&(o=\"a,1\")}),server.on(\"unsubscribed\",function(e,s){console.log(\"Device disconnected : \",e);var r=e.replace(\"settings\",\"\");r=(r=(r=(r=r=e.replace(\"command\",\"\")).replace(\"status\",\"\")).replace(\"data\",\"\")).replace(\"deviceInfo\",\"\");var o=\"w\";s.id.includes(\"esp\")?o=\"m\":s.id.includes(\"APP\")&&(o=\"a,0\");var n={topic:\"status\"+r,payload:o+\",0,\"+r,qos:0,retain:!1};server.publish(n,function(){})}),server.on(\"ready\",setup),app.use(express.static(\"public\")),app.set(\"view engine\",\"ejs\"),app.use(bodyParser.urlencoded({extended:!1})),app.use(bodyParser.json()),app.use(function(e,s,r){s.setHeader(\"Access-Control-Allow-Origin\",\"*\"),s.setHeader(\"Access-Control-Allow-Methods\",\"GET, POST, OPTIONS, PUT, PATCH, DELETE\"),s.setHeader(\"Access-Control-Allow-Headers\",\"X-Requested-With,content-type\"),s.setHeader(\"Access-Control-Allow-Credentials\",!0),r()}),app.get(\"/\",(e,s)=>{var r=void 0==e.query.n_main?10:e.query.n_main;console.log(r),s.render(\"index\",{n:r})}),app.get(\"/login\",(e,s)=>{s.render(\"login\",{title:\"Login\"})}),app.get(\"/subscribe\",(e,s)=>{s.render(\"subscribe\",{title:\"Subscribe\"})}),app.get(\"/listDevices\",(e,s)=>{s.render(\"listDevices\",{title:\"Device List\"})}),app.get(\"/listPrograms\",(e,s)=>{s.render(\"listPrograms\",{title:\"Programs List\"})}),app.post(\"/login\",(e,s)=>{var r=\"SELECT * FROM users WHERE user_email = \"+con.escape(e.body.email)+\" AND user_password = \"+con.escape(sha256(e.body.password));console.log(r),con.query(r,(e,r)=>{console.error(r),r.length<1?s.send(\"E-mail Or Password incorrect.\"):(s.send(r),console.log(r))})}),app.post(\"/subscribe\",(e,s)=>{var r={user_name:e.body.user_name,user_surname:e.body.user_surname,user_email:e.body.user_email,user_password:sha256(e.body.user_password),account_creation_date:moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")};con.query(\"INSERT INTO users SET ?\",r,(e,o)=>{if(e)throw e;s.send(r)})}),app.post(\"/newProgram\",(e,s)=>{con.query(\"INSERT INTO programs SET ?\",{name:e.body.name,pattern:e.body.pattern,user_id:e.body.user_id},(e,r)=>{e?s.status(400).send(\"Program Already Exists\"):s.send(r)})}),app.post(\"/deleteDevice\",(e,s)=>{console.log(\"deleting\"),con.query(\"DELETE FROM user_devices WHERE ?\",{device_id:e.body.device_id},(e,r)=>{e?s.send(e):s.send(r)})}),app.post(\"/changeDeviceSettings\",(e,s)=>{con.query(\"UPDATE user_devices SET high_intensity=?,normal_intensity=?,low_intensity=?,high_intensity_program=?,normal_intensity_program=?,low_intensity_program=?,start_timeout=? WHERE device_id = ?\",[e.body.high,e.body.normal,e.body.low,e.body.high_program,e.body.normal_program,e.body.low_program,e.body.timeout,e.body.device_id],(e,r)=>{e?s.send(e):s.send(r)})}),app.post(\"/modifyProgram\",(e,s)=>{con.query(\"UPDATE programs SET pattern=? WHERE user_id = ? AND name=?\",[e.body.pattern,e.body.user_id,e.body.name],(e,r)=>{console.log(e),e?s.send(e):s.send(r)})}),app.post(\"/deleteSession\",(e,s)=>{console.log(e.body.session_id),con.query(\"DELETE FROM device_sessions WHERE ?\",{session_id:e.body.session_id},(e,r)=>{e?s.send(e):s.send(r)})}),app.post(\"/deleteProgram\",(e,s)=>{con.query(\"DELETE FROM programs WHERE name=? AND user_id=?\",[e.body.name,e.body.user_id],(r,o)=>{con.query(\"Update user_devices SET high_intensity_program='No Program' WHERE ?\",{high_intensity_program:e.body.name},(r,o)=>{con.query(\"Update user_devices SET normal_intensity_program='No Program' WHERE ?\",{normal_intensity_program:e.body.name},(r,o)=>{con.query(\"Update user_devices SET low_intensity_program='No Program' WHERE ?\",{low_intensity_program:e.body.name},(e,r)=>{e?s.send(e):s.send(r)})})})})}),app.post(\"/addDevice\",(e,s)=>{var r=sha256(e.body.user_id+e.body.device_name+new Date().getTime()).toString().substring(0,10).toUpperCase();console.log(e.body),con.query(\"INSERT INTO user_devices SET ?\",{user_id:e.body.user_id,device_name:e.body.device_name,device_id:r,device_creation_date:moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")},(e,o)=>{if(e)throw e;o.device_id=r,s.send(o)})}),app.post(\"/newSession\",(e,s)=>{var r=sha256(e.body.user_id+e.body.device_id+new Date().getTime()).toString().substring(0,10).toUpperCase();con.query(\"INSERT INTO device_sessions SET ?\",{device_id:e.body.device_id,session_id:r,session_creation_date:moment().tz(\"Europe/Tallinn\").format(\"YYYY-MM-DD h:mm:ss\")},(e,o)=>{e?s.send(e):(o.session_id=r,s.send(o))})}),app.post(\"/insertParams\",express.json({type:\"*/*\"}),(e,s)=>{params=Object.values(e.body);for(var r=0;r<params.length;r++)\"param_id\"in params[r]&&(delete params[r].param_id,con.query(\"INSERT INTO parameters SET ?\",params[r],(e,s)=>{if(e)throw e;console.log(s)}));s.send(\"received params\")}),app.post(\"/insertHrData\",express.json({type:\"*/*\"}),(e,s)=>{console.log(e.body)}),app.get(\"/getData\",(e,s)=>{con.query(\"SELECT DATE_FORMAT(date,'%Y-%m-%d %H:%i:%s') as date , rrValue as value FROM data WHERE id= ? ORDER BY logging_date ASC\",{id:e.id},(e,r)=>{if(e)throw e;s.send(r)})});"
}